import React, { useState } from 'react';
import { DragDropContext, Droppable, Draggable } from 'react-beautiful-dnd';
import {
  Box,
  Paper,
  Typography,
  Card,
  CardContent,
  IconButton,
  Menu,
  MenuItem,
  Chip,
  Avatar,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  Select,
  FormControl,
  InputLabel,
  Grid,
} from '@mui/material';
import {
  MoreVert as MoreIcon,
  Add as AddIcon,
  AccessTime as TimeIcon,
  Person as PersonIcon,
  Business as BusinessIcon,
} from '@mui/icons-material';

// Importer les donnÃ©es des entreprises
import { companies } from './Companies';

const initialColumns = {
  'nouveau': {
    id: 'nouveau',
    title: 'Nouveaux leads',
    items: [],
  },
  'contact': {
    id: 'contact',
    title: 'Premier contact',
    items: [
      {
        id: '2',
        title: 'Growth Lead',
        company: 'Avec Vous ?',
        contact: 'Sylvain BouÃ©',
        deadline: '2025-02-20',
        description: 'DiplÃ´mÃ© d\'un Master 2 en Communication Ã  l\'ECS Paris, je cherche un poste de Growth Hacker Outbound B2B. Curieux, crÃ©atif et rigoureux, je suis prÃªt Ã  mettre mes compÃ©tences au service d\'une Ã©quipe dynamique.',
      },
    ],
  },
  'entretien': {
    id: 'entretien',
    title: 'Entretien',
    items: [],
  },
  'proposition': {
    id: 'proposition',
    title: 'Proposition',
    items: [
      {
        id: '3',
        title: 'Growth Lead',
        company: 'Vos Concurrents ðŸ˜‰',
        contact: 'Sylvain BouÃ©',
        deadline: '2025-02-10',
        description: 'Ne laissez pas vos concurrents recruter avant vous ! Mes compÃ©tences en Growth Hacking B2B et mon expÃ©rience peuvent faire la diffÃ©rence.',
      },
    ],
  },
  'cloture': {
    id: 'cloture',
    title: 'ClÃ´turÃ©',
    items: [
      {
        id: '1',
        title: 'Account Manager B2B',
        company: 'EraB2B',
        contact: 'Sylvain BouÃ©',
        deadline: '2024-12-01',
        description: `Account Manager B2B spÃ©cialisÃ© dans la gestion et le dÃ©veloppement de comptes stratÃ©giques.

ðŸŽ¯ Gestion de Comptes :
â€¢ DÃ©veloppement et fidÃ©lisation d'un portefeuille de clients B2B stratÃ©giques
â€¢ Atteinte de 150% des objectifs de croissance sur les comptes existants
â€¢ Mise en place de stratÃ©gies d'expansion et de cross-selling
â€¢ Gestion de comptes reprÃ©sentant un CA annuel de 500Kâ‚¬+

ðŸ’¡ Business Development :
â€¢ Identification et qualification d'opportunitÃ©s de dÃ©veloppement
â€¢ Ã‰laboration de propositions commerciales sur mesure
â€¢ NÃ©gociation et closing de contrats stratÃ©giques
â€¢ Construction de relations long-terme avec les dÃ©cideurs clÃ©s

ðŸš€ RÃ©sultats & Impact :
â€¢ Augmentation de 120% du revenu moyen par compte
â€¢ Taux de rÃ©tention client de 95%
â€¢ DÃ©veloppement de 3 comptes majeurs gÃ©nÃ©rant 40% du CA
â€¢ Mise en place d'un processus de suivi client optimisÃ©`,
        skills: ['Account Management', 'Business Development', 'Social Selling', 'CRM', 'Sales'],
      },
      {
        id: '4',
        title: 'Growth Hacker B2B',
        company: 'Yunico',
        contact: 'Sylvain BouÃ©',
        deadline: '2024-06-01',
        description: `Expert en Growth Marketing B2B focalisÃ© sur l'optimisation des processus commerciaux et l'automatisation intelligente.

ðŸŽ¯ RÃ©alisations Principales :
â€¢ Configuration avancÃ©e de HubSpot comme hub central avec personnalisation poussÃ©e des workflows
â€¢ DÃ©veloppement d'une stratÃ©gie de prospection LinkedIn gÃ©nÃ©rant 100+ leads qualifiÃ©s par mois
â€¢ Mise en place de sÃ©quences d'emails personnalisÃ©es avec un taux d'ouverture de 45%
â€¢ CrÃ©ation d'un systÃ¨me de scoring leads multicritÃ¨res

ðŸ’¡ Optimisations & Automatisations :
â€¢ IntÃ©gration complÃ¨te de la stack marketing (HubSpot, Sales Navigator, Lemlist, Make)
â€¢ DÃ©veloppement de templates de prospection personnalisÃ©s augmentant le taux de rÃ©ponse de 80%
â€¢ CrÃ©ation de workflows d'enrichissement et de qualification automatiques
â€¢ Mise en place d'un systÃ¨me de reporting automatisÃ©

ðŸš€ RÃ©sultats Mesurables :
â€¢ Augmentation de 200% du pipeline commercial en 6 mois
â€¢ RÃ©duction de 70% du temps de prospection manuelle
â€¢ AmÃ©lioration du taux de conversion de 35%
â€¢ ROI marketing multipliÃ© par 3`,
        skills: ['Growth Hacking', 'Marketing B2B', 'CRM', 'Automatisation', 'Social Selling'],
      },
      {
        id: '5',
        title: 'Growth Hacker',
        company: 'BD Multimedia',
        contact: 'Sylvain BouÃ©',
        deadline: '2023-09-01',
        description: `Expert en Growth Hacking et Marketing Digital spÃ©cialisÃ© dans l'acquisition et la conversion.

ðŸŽ¯ RÃ©alisations Marketing :
â€¢ DÃ©veloppement et exÃ©cution de campagnes marketing gÃ©nÃ©rant +150% de trafic qualifiÃ©
â€¢ Mise en place d'une stratÃ©gie SEO multipliant par 3 la visibilitÃ© organique
â€¢ Optimisation des tunnels de conversion augmentant le taux de conversion de 40%
â€¢ CrÃ©ation et test de multiples landing pages avec A/B testing

ðŸ’¡ Innovation & Analytics :
â€¢ ImplÃ©mentation d'un systÃ¨me de tracking avancÃ© avec Google Analytics 4
â€¢ CrÃ©ation de dashboards de performance personnalisÃ©s
â€¢ DÃ©veloppement de stratÃ©gies d'acquisition innovantes
â€¢ Mise en place d'automatisations marketing via Zapier

ðŸš€ RÃ©sultats ClÃ©s :
â€¢ Augmentation de 200% du ROI des campagnes marketing
â€¢ RÃ©duction de 45% du coÃ»t d'acquisition client
â€¢ AmÃ©lioration de 60% du taux d'engagement social media
â€¢ Croissance de 180% du nombre de leads gÃ©nÃ©rÃ©s`,
        skills: ['Growth Hacking', 'Marketing Digital', 'Analytics', 'Social Media', 'SEO'],
      },
      {
        id: '6',
        title: 'ChargÃ© de Communication',
        company: 'Centaure Avocats',
        contact: 'Sylvain BouÃ©',
        deadline: '2023-02-01',
        description: `Responsable de la stratÃ©gie de communication globale et du dÃ©veloppement de la prÃ©sence digitale du cabinet.

ðŸŽ¯ StratÃ©gie & Communication :
â€¢ Ã‰laboration et dÃ©ploiement d'une stratÃ©gie de communication 360Â°
â€¢ Organisation de 5 Ã©vÃ©nements professionnels majeurs (50-200 participants)
â€¢ CrÃ©ation d'une newsletter mensuelle avec un taux d'ouverture de 35%
â€¢ DÃ©veloppement de partenariats stratÃ©giques avec des mÃ©dias juridiques

ðŸ’¡ Marketing Digital & Contenu :
â€¢ Refonte complÃ¨te de l'identitÃ© visuelle du cabinet
â€¢ Production de contenus experts (articles, white papers, podcasts)
â€¢ Gestion et animation des rÃ©seaux sociaux professionnels
â€¢ Mise en place d'une stratÃ©gie de content marketing B2B

ðŸš€ Impact & Performance :
â€¢ Augmentation de 120% de la visibilitÃ© du cabinet
â€¢ Croissance de 80% de l'engagement LinkedIn
â€¢ GÃ©nÃ©ration de 30+ opportunitÃ©s business via le digital
â€¢ AmÃ©lioration de 90% de la rÃ©putation en ligne`,
        skills: ['Communication', 'Marketing', 'Ã‰vÃ©nementiel', 'Relations Publiques', 'Content Strategy'],
      },
      {
        id: '7',
        title: 'Social Media Manager',
        company: 'TaliAcademie.com',
        contact: 'Sylvain BouÃ©',
        deadline: '2022-06-01',
        description: `Expert en gestion des rÃ©seaux sociaux et crÃ©ation de contenu pour une plateforme e-learning en croissance.

ðŸŽ¯ Content & Social Media :
â€¢ CrÃ©ation et gestion de contenus pour 5 plateformes sociales majeures
â€¢ Production de 100+ vidÃ©os Ã©ducatives optimisÃ©es pour chaque plateforme
â€¢ DÃ©veloppement d'une stratÃ©gie de contenu viral gÃ©nÃ©rant 1M+ de vues
â€¢ Animation d'une communautÃ© de 50K+ membres

ðŸ’¡ CrÃ©ativitÃ© & Production :
â€¢ Mise en place d'un workflow de production vidÃ©o optimisÃ©
â€¢ CrÃ©ation de formats innovants augmentant l'engagement de 150%
â€¢ DÃ©veloppement d'une charte graphique cohÃ©rente
â€¢ Production de contenus pÃ©dagogiques engageants

ðŸš€ Performances & Croissance :
â€¢ Croissance organique de 200% des abonnÃ©s en 6 mois
â€¢ Augmentation de 300% du taux d'engagement moyen
â€¢ AmÃ©lioration de 80% du temps de visionnage
â€¢ GÃ©nÃ©ration de 40% du trafic site via les rÃ©seaux sociaux`,
        skills: ['Social Media', 'CrÃ©ation de contenu', 'Montage vidÃ©o', 'Community Management', 'Analytics'],
      },
    ],
  },
};

function Pipeline() {
  const [columns, setColumns] = useState(initialColumns);
  const [menuAnchorEl, setMenuAnchorEl] = useState(null);
  const [selectedCard, setSelectedCard] = useState(null);
  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);
  const [isCompanyDialogOpen, setIsCompanyDialogOpen] = useState(false);
  const [selectedCompany, setSelectedCompany] = useState(null);
  const [newLead, setNewLead] = useState({
    title: '',
    company: '',
    contact: 'Sylvain BouÃ©',
    deadline: '',
  });

  const handleDragEnd = (result) => {
    if (!result.destination) return;

    const { source, destination } = result;

    if (source.droppableId !== destination.droppableId) {
      const sourceColumn = columns[source.droppableId];
      const destColumn = columns[destination.droppableId];
      const sourceItems = [...sourceColumn.items];
      const destItems = [...destColumn.items];
      const [removed] = sourceItems.splice(source.index, 1);
      destItems.splice(destination.index, 0, removed);
      setColumns({
        ...columns,
        [source.droppableId]: {
          ...sourceColumn,
          items: sourceItems,
        },
        [destination.droppableId]: {
          ...destColumn,
          items: destItems,
        },
      });
    } else {
      const column = columns[source.droppableId];
      const copiedItems = [...column.items];
      const [removed] = copiedItems.splice(source.index, 1);
      copiedItems.splice(destination.index, 0, removed);
      setColumns({
        ...columns,
        [source.droppableId]: {
          ...column,
          items: copiedItems,
        },
      });
    }
  };

  const handleMenuClick = (event, card) => {
    setMenuAnchorEl(event.currentTarget);
    setSelectedCard(card);
  };

  const handleMenuClose = () => {
    setMenuAnchorEl(null);
    setSelectedCard(null);
  };

  const handleAddDialogOpen = () => {
    setIsAddDialogOpen(true);
  };

  const handleAddDialogClose = () => {
    setIsAddDialogOpen(false);
    setNewLead({
      title: '',
      company: '',
      contact: 'Sylvain BouÃ©',
      deadline: '',
    });
  };

  const handleAddLead = () => {
    const newLeadWithId = {
      ...newLead,
      id: Math.random().toString(36).substr(2, 9),
    };
    setColumns({
      ...columns,
      nouveau: {
        ...columns.nouveau,
        items: [...columns.nouveau.items, newLeadWithId],
      },
    });
    handleAddDialogClose();
  };

  const handleCompanyClick = (companyName) => {
    const company = companies.find(c => c.name === companyName);
    if (company) {
      setSelectedCompany(company);
      setIsCompanyDialogOpen(true);
    }
  };

  const handleCompanyDialogClose = () => {
    setIsCompanyDialogOpen(false);
    setSelectedCompany(null);
  };

  return (
    <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
      <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 3 }}>
        <Typography variant="h4">Pipeline</Typography>
        <Button
          variant="contained"
          startIcon={<AddIcon />}
          onClick={handleAddDialogOpen}
        >
          Nouveau lead
        </Button>
      </Box>

      <Box sx={{ 
        display: 'flex', 
        gap: 2, 
        overflowX: 'auto', 
        pb: 2, 
        height: 'calc(100vh - 200px)',
        '& > *': {
          flex: '1 0 300px',
          maxWidth: '350px',
        }
      }}>
        <DragDropContext onDragEnd={handleDragEnd}>
          {Object.entries(columns).map(([columnId, column]) => (
            <Paper
              key={columnId}
              sx={{
                height: '100%',
                bgcolor: 'background.paper',
                p: 2,
                borderRadius: 2,
                display: 'flex',
                flexDirection: 'column',
                boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',
                border: '1px solid rgba(0, 164, 189, 0.2)',
                '& .MuiPaper-root': {
                  boxShadow: 'none',
                },
              }}
            >
              <Typography
                variant="h6"
                sx={{
                  mb: 2,
                  pb: 1,
                  borderBottom: '2px solid',
                  borderColor: 'secondary.main',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'space-between',
                  color: 'primary.main',
                  fontWeight: 600,
                  fontSize: '1rem',
                }}
              >
                {column.title}
                <Chip
                  label={column.items.length}
                  size="small"
                  sx={{
                    ml: 1,
                    bgcolor: 'secondary.main',
                    color: 'white',
                    fontWeight: 600,
                    height: '20px',
                    '& .MuiChip-label': {
                      px: 1,
                      fontSize: '0.75rem',
                    },
                  }}
                />
              </Typography>

              <Droppable droppableId={columnId}>
                {(provided, snapshot) => (
                  <Box
                    ref={provided.innerRef}
                    {...provided.droppableProps}
                    sx={{
                      overflowY: 'auto',
                      transition: 'background-color 0.2s ease',
                      bgcolor: snapshot.isDraggingOver ? 'rgba(0, 164, 189, 0.1)' : 'transparent',
                      flexGrow: 1,
                      '&::-webkit-scrollbar': {
                        width: '4px',
                      },
                      '&::-webkit-scrollbar-track': {
                        background: 'transparent',
                      },
                      '&::-webkit-scrollbar-thumb': {
                        background: 'rgba(0, 164, 189, 0.2)',
                        borderRadius: '4px',
                      },
                    }}
                  >
                    {column.items.map((item, index) => (
                      <Draggable
                        key={item.id}
                        draggableId={item.id}
                        index={index}
                      >
                        {(provided, snapshot) => (
                          <Card
                            ref={provided.innerRef}
                            {...provided.draggableProps}
                            {...provided.dragHandleProps}
                            sx={{
                              mb: 1,
                              transform: snapshot.isDragging ? 'rotate(3deg)' : 'none',
                              transition: 'transform 0.2s ease, box-shadow 0.2s ease',
                              '&:hover': {
                                boxShadow: '0 4px 12px rgba(0, 164, 189, 0.2)',
                              },
                            }}
                          >
                            <CardContent sx={{ p: 1.5, '&:last-child': { pb: 1.5 } }}>
                              <Box sx={{ display: 'flex', justifyContent: 'space-between', mb: 0.5, alignItems: 'flex-start' }}>
                                <Typography variant="subtitle2" sx={{ fontWeight: 600, color: 'primary.main', fontSize: '0.875rem' }}>
                                  {item.title}
                                </Typography>
                                <IconButton
                                  size="small"
                                  onClick={(e) => handleMenuClick(e, item)}
                                  sx={{ p: 0.5, mt: -0.5, mr: -0.5 }}
                                >
                                  <MoreIcon fontSize="small" />
                                </IconButton>
                              </Box>
                              <Typography
                                variant="body2"
                                color="text.secondary"
                                sx={{ mb: 1, fontSize: '0.75rem', cursor: 'pointer' }}
                                onClick={() => handleCompanyClick(item.company)}
                              >
                                <BusinessIcon fontSize="small" />
                                {item.company}
                              </Typography>
                              {item.skills && (
                                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 0.5, mb: 1 }}>
                                  {item.skills.map((skill) => (
                                    <Chip
                                      key={skill}
                                      label={skill}
                                      size="small"
                                      variant="outlined"
                                      sx={{ 
                                        borderColor: 'secondary.main', 
                                        color: 'secondary.main',
                                        height: '20px',
                                        '& .MuiChip-label': {
                                          px: 1,
                                          fontSize: '0.7rem',
                                        }
                                      }}
                                    />
                                  ))}
                                </Box>
                              )}
                              {item.description && (
                                <Typography 
                                  variant="body2" 
                                  color="text.secondary" 
                                  sx={{ 
                                    mb: 1,
                                    fontSize: '0.75rem',
                                    display: '-webkit-box',
                                    WebkitLineClamp: 2,
                                    WebkitBoxOrient: 'vertical',
                                    overflow: 'hidden',
                                    textOverflow: 'ellipsis',
                                  }}
                                >
                                  {item.description}
                                </Typography>
                              )}
                              <Box sx={{ 
                                display: 'flex', 
                                justifyContent: 'space-between', 
                                alignItems: 'center',
                              }}>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <Avatar 
                                    sx={{ 
                                      width: 20, 
                                      height: 20, 
                                      bgcolor: 'secondary.main',
                                      fontSize: '0.75rem',
                                    }}
                                  >
                                    {item.contact.charAt(0)}
                                  </Avatar>
                                  <Typography variant="caption" color="text.primary">
                                    {item.contact}
                                  </Typography>
                                </Box>
                                <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
                                  <TimeIcon sx={{ 
                                    fontSize: '0.875rem',
                                    color: columnId === 'cloture' ? 'text.disabled' :
                                           new Date(item.deadline) < new Date() ? 'error.main' :
                                           new Date(item.deadline) < new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) ? 'warning.main' : 'success.main'
                                  }} />
                                  <Typography variant="caption" sx={{
                                    color: columnId === 'cloture' ? 'text.disabled' :
                                           new Date(item.deadline) < new Date() ? 'error.main' :
                                           new Date(item.deadline) < new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) ? 'warning.main' : 'success.main'
                                  }}>
                                    {new Date(item.deadline).toLocaleDateString()}
                                  </Typography>
                                </Box>
                              </Box>
                            </CardContent>
                          </Card>
                        )}
                      </Draggable>
                    ))}
                    {provided.placeholder}
                  </Box>
                )}
              </Droppable>
            </Paper>
          ))}
        </DragDropContext>
      </Box>

      <Menu
        anchorEl={menuAnchorEl}
        open={Boolean(menuAnchorEl)}
        onClose={handleMenuClose}
      >
        <MenuItem onClick={handleMenuClose}>Voir les dÃ©tails</MenuItem>
        <MenuItem onClick={handleMenuClose}>Modifier</MenuItem>
        <MenuItem onClick={handleMenuClose}>Supprimer</MenuItem>
      </Menu>

      <Dialog
        open={isAddDialogOpen}
        onClose={handleAddDialogClose}
        maxWidth="sm"
        fullWidth
      >
        <DialogTitle>Ajouter un nouveau lead</DialogTitle>
        <DialogContent>
          <Grid container spacing={2} sx={{ mt: 1 }}>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="Titre du poste"
                value={newLead.title}
                onChange={(e) => setNewLead({ ...newLead, title: e.target.value })}
              />
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="Entreprise"
                value={newLead.company}
                onChange={(e) => setNewLead({ ...newLead, company: e.target.value })}
              />
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                label="Contact"
                value={newLead.contact}
                onChange={(e) => setNewLead({ ...newLead, contact: e.target.value })}
              />
            </Grid>
            <Grid item xs={12}>
              <TextField
                fullWidth
                type="date"
                label="Date limite"
                value={newLead.deadline}
                onChange={(e) => setNewLead({ ...newLead, deadline: e.target.value })}
                InputLabelProps={{
                  shrink: true,
                }}
              />
            </Grid>
          </Grid>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleAddDialogClose}>Annuler</Button>
          <Button
            onClick={handleAddLead}
            variant="contained"
            disabled={!newLead.title || !newLead.company}
          >
            Ajouter
          </Button>
        </DialogActions>
      </Dialog>

      <Dialog
        open={isCompanyDialogOpen}
        onClose={handleCompanyDialogClose}
        maxWidth="md"
        fullWidth
      >
        {selectedCompany && (
          <>
            <DialogTitle>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                <Typography variant="h5">{selectedCompany.name}</Typography>
                <Chip label={selectedCompany.status} color="primary" />
              </Box>
            </DialogTitle>
            <DialogContent>
              <Typography variant="h6" gutterBottom>{selectedCompany.role}</Typography>
              <Typography variant="body1" paragraph>{selectedCompany.description}</Typography>
              <Box sx={{ mt: 2 }}>
                <Typography variant="subtitle1" gutterBottom>CompÃ©tences :</Typography>
                <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1 }}>
                  {selectedCompany.skills.map((skill, index) => (
                    <Chip key={index} label={skill} />
                  ))}
                </Box>
              </Box>
            </DialogContent>
            <DialogActions>
              <Button onClick={handleCompanyDialogClose}>Fermer</Button>
            </DialogActions>
          </>
        )}
      </Dialog>
    </Box>
  );
}

export default Pipeline;
